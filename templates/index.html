{% extends "base.html" %}

{% block title %}Query Tool{% endblock %}

{% block content %}
<div class="row">
  <!-- Query Form -->
  <div class="col-md-5">
    <div class="card shadow-sm">
      <div class="card-body">
        <h3 class="card-title">Query Domains / IPs</h3>
        <form method="post" id="queryForm">
          <div class="mb-3">
            <textarea class="form-control" name="ips_and_domains" rows="5"
                      placeholder="example.com, 8.8.8.8" required>{{ request.form.get('ips_and_domains', '') }}</textarea>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" name="whois" id="whois" {% if whois_enabled %}checked{% endif %}>
            <label class="form-check-label" for="whois">WHOIS</label>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" name="dns" id="dns" {% if dns_enabled %}checked{% endif %}>
            <label class="form-check-label" for="dns">DNS</label>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" name="ct" id="ct" {% if ct_enabled %}checked{% endif %}>
            <label class="form-check-label" for="ct">Certificate Transparency</label>
          </div>
          <button type="submit" class="btn btn-primary">Query</button>
          <button type="submit" name="export" value="csv" class="btn btn-outline-secondary ms-2">CSV</button>
        </form>
        <div class="mt-3" id="progress" style="display:none;">
          <div class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Tabs -->
  <div class="col-md-7">
    {% if results %}
      <!-- Tabs -->
      <ul class="nav nav-tabs mb-3" id="resultTabs" role="tablist">
        {% for item in ordered_items %}
          <li class="nav-item" role="presentation">
            <button class="nav-link {% if loop.first %}active{% endif %}"
                    id="tab-{{ loop.index }}" data-bs-toggle="tab"
                    data-bs-target="#pane-{{ loop.index }}" role="tab">
              {{ item }}
            </button>
          </li>
        {% endfor %}
      </ul>

      <!-- Tab Content -->
      <div class="tab-content">
        {% for item in ordered_items %}
          {% set data = results[item] %}
          <div class="tab-pane fade {% if loop.first %}show active{% endif %}"
               id="pane-{{ loop.index }}" role="tabpanel">

            <div class="card shadow-sm mb-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <strong>{{ item }}</strong>
                <button class="btn btn-sm btn-outline-info" onclick="showHistory('{{ item }}')">
                  History
                </button>
              </div>
              <div class="card-body">

                <!-- WHOIS -->
                {% if data.whois %}
                  <details open>
                    <summary><strong>WHOIS</strong></summary>
                    <pre><code class="language-text">{{ data.whois }}</code></pre>
                  </details>
                {% endif %}

                <!-- DNS -->
                {% if data.dns %}
                  {% macro render_list(title, items) %}
                    {% if items %}
                      <details open>
                        <summary><strong>{{ title }}</strong></summary>
                        <pre><code class="language-text">{{ items | join('\n') }}</code></pre>
                      </details>
                    {% endif %}
                  {% endmacro %}

                  {{ render_list('A', data.dns.get('A')) }}
                  {{ render_list('AAAA', data.dns.get('AAAA')) }}
                  {{ render_list('CNAME', data.dns.get('CNAME')) }}
                  {{ render_list('NS', data.dns.get('NS')) }}
                  {{ render_list('MX', data.dns.get('MX')) }}
                  {{ render_list('TXT', data.dns.get('TXT')) }}
                    {% if data.dns.get('SPF') %}
                      <details open>
                        <summary><strong>SPF</strong></summary>
                        <pre><code class="language-text">{{ data.dns.SPF | join('\n') }}</code></pre>

                        {% set v = data.dns.get('SPF_validation') %}
                        {% if v %}
                          {% if v.global_errors %}
                            <div class="alert alert-danger mt-2">
                              <strong>Global Errors:</strong><br>
                              {{ v.global_errors | join('<br>') | safe }}
                            </div>
                          {% endif %}

                          {% for rec in v.validations %}
                            {% if not rec.valid %}
                              <div class="alert alert-danger mt-2">
                                <strong>Errors in "{{ rec.record[:60] }}{% if rec.record|length > 60 %}..."{% endif %}"</strong>:<br>
                                {{ rec.errors | join('<br>') | safe }}
                              </div>
                            {% elif rec.warnings %}
                              <div class="alert alert-warning mt-2">
                                <strong>Warnings in "{{ rec.record[:60] }}{% if rec.record|length > 60 %}..."{% endif %}"</strong>:<br>
                                {{ rec.warnings | join('<br>') | safe }}
                              </div>
                            {% endif %}
                            {% if rec.dns_lookups is not none %}
                              <small class="text-muted d-block mt-1">
                                <strong>DNS Lookups:</strong> {{ rec.dns_lookups }}
                                {% if rec.dns_lookups > 10 %} <span class="text-danger">(exceeds RFC limit)</span>{% endif %}
                              </small>
                            {% endif %}
                          {% endfor %}
                        {% endif %}
                      </details>
                    {% endif %}
                  {{ render_list('DMARC', data.dns.get('DMARC')) }}
                  {{ render_list('BIMI', data.dns.get('BIMI')) }}

                  {% if data.dns.get('blacklist') %}
                    <details open>
                      <summary><strong>Blacklist</strong></summary>
                      <pre><code class="language-json">{{ data.dns.blacklist | tojson }}</code></pre>
                    </details>
                  {% endif %}

                  <!-- Well-Known Subdomains -->
                  {% if data.dns.get('Well-Known') %}
                    <details open>
                      <summary><strong>Well-Known Subdomains ({{ data.dns['Well-Known']|length }})</strong></summary>
                      {% for fqdn, recs in data.dns['Well-Known'].items() %}
                        <details>
                          <summary><strong>{{ fqdn }}</strong></summary>
                          <ul class="list-group list-group-flush">
                            {% if recs.get('A') %}<li class="list-group-item">A: {{ recs.A | join(', ') }}</li>{% endif %}
                            {% if recs.get('AAAA') %}<li class="list-group-item">AAAA: {{ recs.AAAA | join(', ') }}</li>{% endif %}
                            {% if recs.get('CNAME') %}<li class="list-group-item">CNAME: {{ recs.CNAME | join(', ') }}</li>{% endif %}
                          </ul>
                        </details>
                      {% endfor %}
                    </details>
                  {% endif %}
                {% endif %}

                <!-- CT -->
                {% if data.ct %}
                  {% if 'error' in data.ct %}
                    <details>
                      <summary><strong>CT Error</strong></summary>
                      <div class="alert alert-danger">
                        <strong>Error:</strong> {{ data.ct.error }}
                      </div>
                    </details>
                  {% else %}
                    <details open>
                      <summary><strong>CT Subdomains ({{ data.ct | length }})</strong></summary>
                      <ul class="list-group">
                        {% for sub, rec in data.ct.items() %}
                          <li class="list-group-item">
                            <strong>{{ sub }}</strong>
                            {% if rec.A %} (A: {{ rec.A | join(', ') }}) {% endif %}
                            {% if rec.CNAME %} (CNAME: {{ rec.CNAME | join(', ') }}) {% endif %}
                          </li>
                        {% endfor %}
                      </ul>
                    </details>
                  {% endif %}
                {% endif %}

              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

<script>
  // Show progress bar on submit
  document.getElementById('queryForm').onsubmit = () => {
    document.getElementById('progress').style.display = 'block';
  };
</script>
{% endblock %}
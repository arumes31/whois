{{ template "header" . }}

<div class="row g-4">
    <!-- Main Search & Config -->
    <div class="col-xl-8">
        <div class="search-section mt-0 mb-4" style="max-width: 100%;">
            <div class="glass-panel border-nordic">
                <div class="d-flex align-items-center mb-4">
                    <div class="flex-grow-1">
                        <h4 class="mb-0 fw-bold"><i class="fas fa-cogs me-2 text-info"></i> MECHANICAL DIAGNOSTICS</h4>
                        <p class="text-muted small mb-0">Steam-powered analytical engine for network reconnaissance</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button onclick="clearResults()" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-undo me-1"></i> FLUSH
                        </button>
                    </div>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-9">
                        <div class="input-group">
                            <span class="input-group-text bg-dark border-secondary text-muted"><i class="fas fa-anchor"></i></span>
                            <textarea 
                              id="targetInput"
                              class="form-control matrix-input" 
                              rows="1"
                              placeholder="google.com, 1.1.1.1, sub.domain.tld ..."
                              required></textarea>
                            <button class="btn btn-outline-secondary matrix-input px-3" onclick="document.getElementById('fileInput').click()" title="Coal Feed (Batch)">
                                <i class="fas fa-upload"></i>
                            </button>
                            <input type="file" id="fileInput" style="display:none" onchange="handleFileUpload(this)">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <button onclick="startQuery()" class="btn btn-danger w-100 fw-bold h-100">
                            <i class="fas fa-fire me-2"></i> FIRE FURNACE
                        </button>
                    </div>
                </div>
                
                <div class="mt-4 pt-3 border-top border-secondary opacity-25">
                    <div class="d-flex flex-wrap gap-2">
                        <div class="feature-toggle">
                            <input type="checkbox" id="cfg-whois" {{ if .config.EnableWhois }}checked{{ end }}>
                            <label for="cfg-whois"><i class="fas fa-book me-1 opacity-50"></i>REGISTRY</label>
                        </div>
                        <div class="feature-toggle">
                            <input type="checkbox" id="cfg-dns" {{ if .config.EnableDNS }}checked{{ end }}>
                            <label for="cfg-dns"><i class="fas fa-compass me-1 opacity-50"></i>DNS</label>
                        </div>
                        <div class="feature-toggle">
                            <input type="checkbox" id="cfg-subdomains">
                            <label for="cfg-subdomains"><i class="fas fa-sitemap me-1 opacity-50"></i>PREFIXES</label>
                        </div>
                        <div class="feature-toggle">
                            <input type="checkbox" id="cfg-ssl" {{ if .config.EnableSSL }}checked{{ end }}>
                            <label for="cfg-ssl"><i class="fas fa-lock me-1 opacity-50"></i>CIPHER</label>
                        </div>
                        <div class="feature-toggle">
                            <input type="checkbox" id="cfg-http" {{ if .config.EnableHTTP }}checked{{ end }}>
                            <label for="cfg-http"><i class="fas fa-atlas me-1 opacity-50"></i>HTTP</label>
                        </div>
                        <div class="feature-toggle">
                            <input type="checkbox" id="cfg-geo" {{ if .config.EnableGeo }}checked{{ end }}>
                            <label for="cfg-geo"><i class="fas fa-globe me-1 opacity-50"></i>CHART</label>
                        </div>
                        <div class="feature-toggle">
                            <input type="checkbox" id="cfg-ct" {{ if .config.EnableCT }}checked{{ end }}>
                            <label for="cfg-ct"><i class="fas fa-history me-1 opacity-50"></i>LOGS</label>
                        </div>
                        <div class="feature-toggle">
                            <input type="checkbox" id="cfg-ping">
                            <label for="cfg-ping"><i class="fas fa-tachometer-alt me-1 opacity-50"></i>PRESSURE</label>
                        </div>
                        <div class="feature-toggle">
                            <input type="checkbox" id="cfg-trace">
                            <label for="cfg-trace"><i class="fas fa-route me-1 opacity-50"></i>TRACE</label>
                        </div>
                        <div class="feature-toggle">
                            <input type="checkbox" id="cfg-route">
                            <label for="cfg-route"><i class="fas fa-map me-1 opacity-50"></i>ROUTE</label>
                        </div>
                        <div class="feature-toggle">
                            <input type="checkbox" id="cfg-portscan">
                            <label for="cfg-portscan"><i class="fas fa-key me-1 opacity-50"></i>GATES</label>
                        </div>
                        <div id="portsInputWrapper" style="display:none; margin-top: -5px;">
                            <input type="text" id="cfg-ports" class="form-control matrix-input py-1" style="font-size: 0.7rem; width: 140px;" value="80,443,22,21,3389" placeholder="Specific gates...">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workspace Area -->
        <div id="resultsGrid" class="results-grid">
            <!-- Widgets injected here -->
        </div>
    </div>

    <!-- Quick Tools & Side Info -->
    <div class="col-xl-4">
        <div class="glass-panel border-nordic mb-4">
            <h5 class="fw-bold mb-3"><i class="fas fa-tools me-2 text-warning"></i> ENGINE TOOLS</h5>
            <div class="list-group list-group-flush bg-transparent">
                <a href="#" onclick="openTool('dns')" class="list-group-item bg-transparent text-muted border-secondary py-3 px-0 d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-search me-3 text-info"></i> DNS INTERROGATOR</span>
                    <i class="fas fa-chevron-right small opacity-50"></i>
                </a>
                <a href="#" onclick="openTool('mac')" class="list-group-item bg-transparent text-muted border-secondary py-3 px-0 d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-barcode me-3 text-warning"></i> HARDWARE LOOKUP</span>
                    <i class="fas fa-chevron-right small opacity-50"></i>
                </a>
                <a href="/metrics" target="_blank" class="list-group-item bg-transparent text-muted border-0 py-3 px-0 d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-chart-line me-3 text-danger"></i> ENGINE METRICS</span>
                    <i class="fas fa-external-link-alt small opacity-50"></i>
                </a>
            </div>
        </div>

        <div class="glass-panel border-nordic mb-4 h-100" style="min-height: 400px; display: flex; flex-direction: column;">
            <h6 class="text-muted small border-bottom border-secondary pb-2 mb-3">
                <i class="fas fa-cog fa-spin me-2 text-danger"></i> MECHANISM ACTIVITY
            </h6>
            <div id="liveLog" class="flex-grow-1 font-monospace" style="font-size: 0.7rem; overflow-y: auto; max-height: 600px;">
                <div class="text-muted italic">Awaiting pressure data...</div>
            </div>
        </div>
    </div>
</div>

<template id="resultCardTemplate">
    <div class="result-card glass-panel" data-target="" draggable="true">
        <div class="card-handle">
            <div class="d-flex align-items-center gap-2">
                <i class="fas fa-wrench text-muted"></i>
                <small class="text-muted fw-bold">VALVE-DATA</small>
            </div>
            <button class="btn btn-link btn-sm text-muted p-0" onclick="this.closest('.result-card').remove()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="d-flex justify-content-between align-items-start mb-3 p-3">
            <h5 class="target-name mb-0 font-monospace text-danger"></h5>
            <div class="d-flex gap-2 align-items-center">
                <span class="badge bg-nordic-blue-dim text-nordic-blue small status-badge">standby</span>
                <i class="fas fa-sync-alt text-muted" style="cursor:pointer; font-size: 0.8rem;" onclick="reScanTarget(this)" title="Recalibrate"></i>
                <i class="fas fa-copy copy-btn" onclick="copyTarget(this)" title="Copy target"></i>
                <div class="streaming-indicator"></div>
            </div>
        </div>
        <div class="progress mx-3 mb-3" style="height: 4px; background: rgba(0,0,0,0.5);">
            <div class="progress-bar bg-danger" role="progressbar" style="width: 0%"></div>
        </div>
        <div class="diagnostic-content p-3 pt-0">
            <div class="service-section" data-service="geo"></div>
            <div class="service-section" data-service="subdomains"></div>
            <div class="service-section" data-service="portscan"></div>
            <div class="service-section" data-service="ping"></div>
            <div class="service-section" data-service="route"></div>
            <div class="service-section" data-service="trace"></div>
            <div class="service-section" data-service="dns"></div>
            <div class="service-section" data-service="ssl"></div>
            <div class="service-section" data-service="http"></div>
            <div class="service-section" data-service="whois"></div>
            <div class="service-section" data-service="ct"></div>
        </div>
    </div>
</template>

<script>
let socket;
const activeScans = new Map();

function connectWS() {
    const proto = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    socket = new WebSocket(`${proto}//${window.location.host}/ws`);
    
    socket.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        updateUI(msg);
    };

    socket.onclose = () => {
        console.log("Socket closed. Reconnecting...");
        setTimeout(connectWS, 2000);
    };
}

function handleFileUpload(input) {
    const file = input.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    fetch('/bulk-upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            document.getElementById('targetInput').value = data.targets.join(', ');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Upload failed');
    });
}

function appendLog(target, message) {
    const log = document.getElementById('liveLog');
    const time = new Date().toLocaleTimeString();
    const entry = document.createElement('div');
    entry.className = "mb-1";
    entry.innerHTML = `<span class="text-muted">[${time}]</span> <span class="text-danger">${target}</span>: ${message}`;
    log.appendChild(entry);
    log.scrollTop = log.scrollHeight;
    
    // Remove "Waiting" message if present
    const waiting = log.querySelector('.italic');
    if (waiting) waiting.remove();
}

function startQuery() {
    const targets = document.getElementById('targetInput').value.split(',').map(t => t.trim()).filter(t => t !== "");
    if (targets.length === 0) return;

    const isIP = (str) => {
        const regex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$|^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/;
        return regex.test(str);
    };

    targets.forEach(t => {
        const targetIsIP = isIP(t);
        const config = {
            whois: document.getElementById('cfg-whois').checked,
            dns: document.getElementById('cfg-dns').checked,
            ssl: document.getElementById('cfg-ssl').checked,
            http: document.getElementById('cfg-http').checked,
            geo: document.getElementById('cfg-geo').checked,
            ct: document.getElementById('cfg-ct').checked,
            ping: document.getElementById('cfg-ping').checked,
            trace: document.getElementById('cfg-trace').checked,
            route: document.getElementById('cfg-route').checked,
            subdomains: document.getElementById('cfg-subdomains').checked,
            portscan: document.getElementById('cfg-portscan').checked && targetIsIP,
            ports: document.getElementById('cfg-portscan').checked ? document.getElementById('cfg-ports').value : "",
        };

        const enabledServices = Object.values(config).filter(v => v && v !== "").length;

        createCard(t);
        activeScans.set(t, {
            total: enabledServices,
            completed: 0
        });
        updateProgressBar(t);
        socket.send(JSON.stringify({ targets: [t], config }));
    });
}

function getDragAfterElement(container, x, y) {
    const draggableElements = [...container.querySelectorAll('.result-card:not(.dragging)')];

    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offsetX = x - box.left - box.width / 2;
        const offsetY = y - box.top - box.height / 2;
        const distance = Math.sqrt(offsetX * offsetX + offsetY * offsetY);
        
        if (distance < closest.distance) {
            return { distance: distance, element: child };
        } else {
            return closest;
        }
    }, { distance: Number.POSITIVE_INFINITY }).element;
}

function createCard(target) {
    let card = document.querySelector(`[data-target="${target}"]`);
    if (card) {
        card.remove(); // Re-create for fresh scan
    }

    const template = document.getElementById('resultCardTemplate');
    const clone = template.content.cloneNode(true);
    card = clone.querySelector('.result-card');
    
    card.setAttribute('data-target', target);
    card.querySelector('.target-name').innerText = target;
    
    // Drag Events
    card.addEventListener('dragstart', (e) => {
        card.classList.add('dragging');
        e.dataTransfer.setData('text/plain', target);
    });

    card.addEventListener('dragend', () => {
        card.classList.remove('dragging');
    });

    const resultsGrid = document.getElementById('resultsGrid');
    resultsGrid.addEventListener('dragover', (e) => {
        e.preventDefault();
        const draggable = document.querySelector('.dragging');
        if (!draggable) return;
        
        const afterElement = getDragAfterElement(resultsGrid, e.clientX, e.clientY);
        if (afterElement == null) {
            resultsGrid.appendChild(draggable);
        } else {
            resultsGrid.insertBefore(draggable, afterElement);
        }
    });

    const isIP = (str) => {
        const regex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$|^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/;
        return regex.test(str);
    };
    const targetIsIP = isIP(target);

    // Add skeletons to enabled services
    const config = {
        whois: document.getElementById('cfg-whois').checked,
        dns: document.getElementById('cfg-dns').checked,
        ssl: document.getElementById('cfg-ssl').checked,
        http: document.getElementById('cfg-http').checked,
        geo: document.getElementById('cfg-geo').checked,
        ct: document.getElementById('cfg-ct').checked,
        ping: document.getElementById('cfg-ping').checked,
        trace: document.getElementById('cfg-trace').checked,
        route: document.getElementById('cfg-route').checked,
        portscan: document.getElementById('cfg-portscan').checked && targetIsIP,
        subdomains: document.getElementById('cfg-subdomains').checked,
    };

    for (const [service, enabled] of Object.entries(config)) {
        if (enabled) {
            const section = card.querySelector(`[data-service="${service}"]`);
            if (section) {
                section.innerHTML = `
                    <div class="skeleton-wrapper p-2">
                        <div class="skeleton mb-2" style="height: 12px; width: 40%"></div>
                        <div class="skeleton" style="height: 8px; width: 80%"></div>
                    </div>`;
            }
        }
    }

    document.getElementById('resultsGrid').prepend(card);
}

function updateProgressBar(target) {
    const card = document.querySelector(`[data-target="${target}"]`);
    if (!card) return;

    const scan = activeScans.get(target);
    if (!scan) return;

    const percent = (scan.completed / scan.total) * 100;
    const bar = card.querySelector('.progress-bar');
    bar.style.width = `${percent}%`;

    const statusBadge = card.querySelector('.status-badge');
    if (scan.completed === scan.total) {
        statusBadge.innerText = "completed";
        statusBadge.classList.replace('bg-nordic-blue-dim', 'bg-success-dim');
        statusBadge.classList.replace('text-nordic-blue', 'text-success');
        card.querySelector('.streaming-indicator').style.display = 'none';
    } else {
        statusBadge.innerText = "scanning...";
    }
}

function updateUI(msg) {
    if (msg.type === 'log') {
        appendLog(msg.target, msg.data);
        return;
    }

    const card = document.querySelector(`[data-target="${msg.target}"]`);
    if (!card) return;

    const section = card.querySelector(`[data-service="${msg.service}"]`);
    if (!section) return;

    const scan = activeScans.get(msg.target);
    if (scan) {
        scan.completed++;
        updateProgressBar(msg.target);
    }

    let html = "";
    const data = msg.data;

    switch(msg.service) {
        case 'geo':
            if (data && !data.error) {
                html = `<details open><summary>LOCATION & ASN <i class="fas fa-info-circle ms-1 help-icon" data-tippy-content="Physical location and network owner data"></i></summary>
                        <div class="p-2 small">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-map-marker-alt me-3 text-danger fa-lg"></i>
                                <div>
                                    <div class="fw-bold">${data.city || 'Unknown City'}, ${data.country}</div>
                                    <div class="text-muted" style="font-size:0.65rem;">${data.timezone || ''}</div>
                                </div>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-network-wired me-3 text-info fa-lg"></i>
                                <div>
                                    <div class="fw-bold">${data.as || 'Unknown AS'}</div>
                                    <div class="text-muted" style="font-size:0.65rem;">IP: ${data.query}</div>
                                </div>
                            </div>
                            <div class="mt-2 pt-2 border-top border-secondary opacity-25">
                                <div class="text-muted" style="font-size:0.6rem; letter-spacing:1px;">COORDINATES: ${data.lat}, ${data.lon}</div>
                            </div>
                        </div></details>`;
            } else {
                html = `<details><summary>LOCATION & ASN</summary><div class="p-2 text-muted small">Geo data unavailable</div></details>`;
            }
            break;
        case 'subdomains':
            if (data && Object.keys(data).length > 0) {
                html = `<details open><summary>SUBDOMAIN DISCOVERY <i class="fas fa-info-circle ms-1 help-icon" data-tippy-content="Brute-forced common prefixes"></i></summary>
                        <div class="p-2 small">
`;
                for (const [fqdn, records] of Object.entries(data)) {
                    html += `<div class="mb-2 pb-1 border-bottom border-secondary opacity-25">
                                <div class="text-danger fw-bold">${fqdn}</div>
                                <div class="ps-2">
`;
                    for (const [type, vals] of Object.entries(records)) {
                        html += `<div class="text-muted" style="font-size: 0.65rem;"><span class="text-info">${type}:</span> ${vals.join(', ')}</div>`;
                    }
                    html += `</div></div>`;
                }
                html += `</div></details>`;
            } else {
                html = `<details><summary>SUBDOMAIN DISCOVERY</summary><div class="p-2 text-muted small">No common subdomains found</div></details>`;
            }
            break;
        case 'portscan':
            if (data && Object.keys(data).length > 0) {
                html = `<details open><summary>PORT SCAN <i class="fas fa-info-circle ms-1 help-icon" data-tippy-content="Open ports and service banners"></i></summary>
                        <div class="p-2">
`;
                for (const [port, banner] of Object.entries(data)) {
                    html += `<div class="d-flex justify-content-between align-items-center mb-1 small">
                                <span class="badge bg-danger-dim text-danger" style="width: 60px;">${port}</span>
                                <span class="text-info font-monospace flex-grow-1 ms-2" style="font-size: 0.65rem;">${banner || 'Open (No Banner)'}</span>
                             </div>`;
                }
                html += `</div></details>`;
            } else {
                html = `<details><summary>PORT SCAN</summary><div class="p-2 text-muted small">No open ports found</div></details>`;
            }
            break;
        case 'ping':
            html = `<details open><summary>PING ICMP <i class="fas fa-info-circle ms-1 help-icon" data-tippy-content="Real-time latency check"></i></summary>
                    <pre class="p-2 mt-1 rounded bg-dark text-success" style="font-size: 0.7rem; min-height: 60px;"><code>${data.join('\n')}</code></pre>
                    </details>`;
            break;
        case 'route':
            html = `<details><summary>TRACEROUTE <i class="fas fa-info-circle ms-1 help-icon" data-tippy-content="Network hop analysis"></i></summary>
                    <pre class="p-2 mt-1 rounded bg-dark text-info" style="font-size: 0.7rem; min-height: 60px;"><code>${data.join('\n')}</code></pre>
                    </details>`;
            break;
        case 'trace':
            html = `<details><summary>DNS TRACE <i class="fas fa-info-circle ms-1 help-icon" data-tippy-content="Recursive resolution from root"></i></summary>
                    <pre class="p-2 mt-1 rounded" style="font-size: 0.7rem;"><code>${data.join('\n')}</code></pre>
                    </details>`;
            break;
        case 'dns':
            if (data && data.error) {
                html = `<details><summary>DNS RECORDS</summary><div class="p-2 text-danger small">${data.error}</div></details>`;
            } else if (data && Object.keys(data).length > 0) {
                html = `<details><summary>DNS RECORDS <i class="fas fa-info-circle ms-1 help-icon" data-tippy-content="A, MX, TXT and other zone records"></i></summary><pre class="p-2 mt-1 rounded"><code>`;
                for (const [type, records] of Object.entries(data)) {
                    html += `[${type}]\n${records.join('\n')}\n\n`;
                }
                html += `</code></pre></details>`;
            } else {
                html = `<details><summary>DNS RECORDS</summary><div class="p-2 text-muted small">No records found</div></details>`;
            }
            break;
        case 'ssl':
            if (data.error) {
                html = `<details><summary>SSL/TLS</summary><div class="p-2 text-muted small">${data.error}</div></details>`;
            } else {
                html = `<details><summary>SSL/TLS <i class="fas fa-info-circle ms-1 help-icon" data-tippy-content="TLS Handshake and Certificate Validity"></i></summary>
                        <div class="p-2 small">
                            <span class="badge bg-success mb-2">${data.protocol}</span><br>
                            <strong>Issuer:</strong> ${data.issuer}<br>
                            <strong>Expiry:</strong> ${data.expiry.split('T')[0]} (${data.days_left}d)
                        </div></details>`;
            }
            break;
        case 'http':
            if (data.error) {
                html = `<details><summary>HTTP</summary><div class="p-2 text-muted small">${data.error}</div></details>`;
            } else {
                let securityHtml = "";
                for (const [h, val] of Object.entries(data.security)) {
                    const isSet = val !== "Not Set";
                    securityHtml += `<div class="d-flex justify-content-between mb-1">
                        <span class="text-muted" style="font-size: 0.65rem;">${h}</span>
                        <span class="badge ${isSet ? 'bg-success-dim text-success' : 'bg-danger-dim text-danger'}" style="font-size: 0.6rem;">${isSet ? 'SECURE' : 'MISSING'}</span>
                    </div>`;
                }

                html = `<details><summary>HTTP INSPECTOR <i class="fas fa-info-circle ms-1 help-icon" data-tippy-content="Security headers and response metadata"></i></summary>
                        <div class="p-2 small">
                            <div class="d-flex justify-content-between mb-2 align-items-center">
                                <strong>Status:</strong> <span class="badge ${data.status.startsWith('2') ? 'bg-success' : 'bg-warning'}">${data.status}</span>
                                <span class="badge bg-dark border border-secondary text-info">${data.response_time_ms}ms</span>
                            </div>
                            <div class="mb-2"><strong>Protocol:</strong> ${data.protocol}</div>
                            <div class="mb-2"><strong>Server:</strong> ${data.headers.Server || 'Unknown'}</div>
                            <div class="security-headers-minimal mb-2">
                                ${securityHtml}
                            </div>
                            <details class="mt-2"><summary><small>FULL HEADERS</small></summary>
                            <pre class="p-2 mt-1 rounded" style="font-size: 0.7rem;"><code>${JSON.stringify(data.headers, null, 2)}</code></pre>
                            </details>
                        </div></details>`;
            }
            break;
        case 'whois':
            if (data && typeof data === 'object') {
                html = `<details open><summary>WHOIS INTEL</summary>
                        <div class="p-2 small">
                            <strong>Registrar:</strong> ${data.registrar || 'Unknown'}<br>
                            <strong>Expires:</strong> ${data.expiry || 'Unknown'}<br>
                            <strong>Created:</strong> ${data.created || 'Unknown'}
                        </div>
                        <details><summary><small>RAW DATA</small></summary>
                        <pre class="p-2 mt-1 rounded"><code>${data.raw}</code></pre>
                        </details></details>`;
            } else if (data) {
                html = `<details><summary>WHOIS RAW</summary><pre class="p-2 mt-1 rounded"><code>${data}</code></pre></details>`;
            } else {
                html = `<details><summary>WHOIS</summary><div class="p-2 text-muted small">No WHOIS data</div></details>`;
            }
            break;
        case 'ct':
            if (data && data.error) {
                html = `<details><summary>CT SUBDOMAINS</summary><div class="p-2 text-danger small">${data.error}</div></details>`;
            } else if (data && Object.keys(data).length > 0) {
                html = `<details><summary>CT SUBDOMAINS</summary><ul class="list-unstyled p-2 small m-0" style="max-height: 150px; overflow-y: auto;">`;
                for (const [sub, _] of Object.entries(data)) {
                    html += `<li><i class="fas fa-caret-right me-2 text-danger"></i>${sub}</li>`;
                }
                html += `</ul></details>`;
            } else {
                html = `<details><summary>CT SUBDOMAINS</summary><div class="p-2 text-muted small">No subdomains found</div></details>`;
            }
            break;
    }

    section.innerHTML = html;
    
    // Add copy button to summary if it doesn't have one
    section.querySelectorAll('summary').forEach(s => {
        if (!s.querySelector('.section-copy-btn')) {
            const btn = document.createElement('i');
            btn.className = "fas fa-copy ms-2 text-muted section-copy-btn";
            btn.style = "cursor:pointer; font-size: 0.7rem;";
            btn.title = "Copy Section";
            btn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                const text = s.parentElement.querySelector('div, pre, ul').innerText;
                navigator.clipboard.writeText(text.trim());
                const original = btn.className;
                btn.className = "fas fa-check text-success ms-2";
                setTimeout(() => btn.className = original, 1500);
            };
            s.appendChild(btn);
        }
    });

    // Initialize tooltips for new content
    tippy(section.querySelectorAll('.help-icon'), {
        theme: 'matrix',
        placement: 'right'
    });

    Prism.highlightAllUnder(section);
}

function exportToCSV() {
    const cards = document.querySelectorAll('.result-card');
    if (cards.length === 0) return;

    let csv = "Target,Service,Data\n";
    cards.forEach(card => {
        const target = card.getAttribute('data-target');
        const sections = card.querySelectorAll('.service-section');
        sections.forEach(section => {
            const service = section.getAttribute('data-service');
            const data = section.innerText.replace(/"/g, '""');
            csv += `"${target}","${service}","${data}"\n`;
        });
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('href', url);
    a.setAttribute('download', `scan_results_${new Date().getTime()}.csv`);
    a.click();
}

function exportToJSON() {
    const data = getAllResultsData();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('href', url);
    a.setAttribute('download', `scan_results_${new Date().getTime()}.json`);
    a.click();
}

function copyAllJSON() {
    const data = getAllResultsData();
    navigator.clipboard.writeText(JSON.stringify(data, null, 2));
    alert("All results copied to clipboard as JSON");
}

function getAllResultsData() {
    const cards = document.querySelectorAll('.result-card');
    const results = [];
    cards.forEach(card => {
        const target = card.getAttribute('data-target');
        const sections = {};
        card.querySelectorAll('.service-section').forEach(section => {
            const service = section.getAttribute('data-service');
            sections[service] = section.innerText.trim();
        });
        results.push({ target, services: sections });
    });
    return results;
}

function reScanTarget(btn) {
    const target = btn.closest('.result-card').getAttribute('data-target');
    const isIP = (str) => {
        const regex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$|^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/;
        return regex.test(str);
    };
    const targetIsIP = isIP(target);

    const config = {
        whois: document.getElementById('cfg-whois').checked,
        dns: document.getElementById('cfg-dns').checked,
        ssl: document.getElementById('cfg-ssl').checked,
        http: document.getElementById('cfg-http').checked,
        geo: document.getElementById('cfg-geo').checked,
        ct: document.getElementById('cfg-ct').checked,
        ping: document.getElementById('cfg-ping').checked,
        trace: document.getElementById('cfg-trace').checked,
        route: document.getElementById('cfg-route').checked,
        subdomains: document.getElementById('cfg-subdomains').checked,
        portscan: document.getElementById('cfg-portscan').checked && targetIsIP,
        ports: document.getElementById('cfg-portscan').checked ? document.getElementById('cfg-ports').value : "",
    };
    
    const enabledServices = Object.values(config).filter(v => v && v !== "").length;
    createCard(target);
    activeScans.set(target, {
        total: enabledServices,
        completed: 0
    });
    updateProgressBar(target);
    socket.send(JSON.stringify({ targets: [target], config }));
}

function copyTarget(btn) {
    const target = btn.closest('.result-card').getAttribute('data-target');
    navigator.clipboard.writeText(target);
    const originalIcon = btn.className;
    btn.className = "fas fa-check text-success";
    setTimeout(() => btn.className = originalIcon, 2000);
}

// Cookie Management
function setCookie(name, value, days = 7) {
    const expires = new Date(Date.now() + days * 864e5).toUTCString();
    document.cookie = name + '=' + encodeURIComponent(value) + '; expires=' + expires + '; path=/; SameSite=Lax';
}

function getCookie(name) {
    return document.cookie.split('; ').reduce((r, v) => {
        const parts = v.split('=');
        return parts[0] === name ? decodeURIComponent(parts[1]) : r;
    }, '');
}

function saveSettings() {
    const config = {
        whois: document.getElementById('cfg-whois').checked,
        dns: document.getElementById('cfg-dns').checked,
        ssl: document.getElementById('cfg-ssl').checked,
        http: document.getElementById('cfg-http').checked,
        geo: document.getElementById('cfg-geo').checked,
        ct: document.getElementById('cfg-ct').checked,
        ping: document.getElementById('cfg-ping').checked,
        trace: document.getElementById('cfg-trace').checked,
        route: document.getElementById('cfg-route').checked,
        subdomains: document.getElementById('cfg-subdomains').checked,
        portscan: document.getElementById('cfg-portscan').checked,
        ports: document.getElementById('cfg-ports').value
    };
    setCookie('whois_settings', JSON.stringify(config));
}

function loadSettings() {
    const saved = getCookie('whois_settings');
    if (!saved) return;
    try {
        const config = JSON.parse(saved);
        Object.keys(config).forEach(key => {
            const el = document.getElementById('cfg-' + key);
            if (el) {
                if (el.type === 'checkbox') el.checked = config[key];
                else el.value = config[key];
            }
        });
        // Trigger visibility for ports wrapper
        document.getElementById('portsInputWrapper').style.display = config.portscan ? 'block' : 'none';
    } catch (e) { console.error("Failed to load settings", e); }
}

// Keyboard Shortcuts
document.addEventListener('keydown', (e) => {
    // Ctrl + Enter to scan
    if (e.ctrlKey && e.key === 'Enter') {
        startQuery();
    }
    // '/' to focus search
    if (e.key === '/' && document.activeElement.tagName !== 'TEXTAREA') {
        e.preventDefault();
        document.getElementById('targetInput').focus();
    }
});

function clearResults() {
    document.getElementById('resultsGrid').innerHTML = "";
    document.getElementById('targetInput').value = "";
}

// Add event listeners for saving
document.querySelectorAll('.feature-toggle input, #cfg-ports').forEach(el => {
    el.addEventListener('change', saveSettings);
});

// Initialize connection and settings
loadSettings();
connectWS();

// Initial global tooltips
tippy('[title]', { theme: 'matrix' });
</script>

{{ template "footer" . }}

{{ template "header" . }}

<div class="row g-4">
    <!-- Main Search & Config -->
    <div class="col-xl-8">
        <div class="search-section mt-0 mb-4" style="max-width: 100%;">
            <div class="glass-panel border-nordic">
                <div class="d-flex align-items-center mb-4">
                    <div class="flex-grow-1">
                        <h4 class="mb-0 fw-bold">
                            <svg style="width:20px;height:20px;margin-right:8px;fill:#0dcaf0" viewBox="0 0 512 512"><path d="M416 0c-17.7 0-32 14.3-32 32s14.3 32 32 32h32V128H320V96c0-17.7-14.3-32-32-32s-32 14.3-32 32V384c0 17.7 14.3 32 32 32s32-14.3 32-32V352H448v64H416c-17.7 0-32 14.3-32 32s14.3 32 32 32h96c17.7 0 32-14.3 32-32s-14.3-32-32-32H480V128h32c17.7 0 32-14.3 32-32s-14.3-32-32-32H416zM32 128c-17.7 0-32 14.3-32 32V352c0 17.7 14.3 32 32 32H224c17.7 0 32-14.3 32-32V160c0-17.7-14.3-32-32-32H32zM64 192h32v32H64V192zm96 0h32v32h-32V192zM64 288h32v32H64V288zm96 0h32v32h-32V288z"/></svg>
                            LOOKUP
                        </h4>
                        <p class="text-muted small mb-0">Multi-vector diagnostic analysis for network recon</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button onclick="clearResults()" class="btn btn-sm btn-outline-secondary" title="Clear all search results and target list">
                            <svg style="width:12px;height:12px;margin-right:4px;fill:currentColor" viewBox="0 0 512 512"><path d="M105.1 202.6c7.7-21.8 20.2-42.3 37.8-59.8c62.5-62.5 163.8-62.5 226.3 0L386.3 160H336c-17.7 0-32 14.3-32 32s14.3 32 32 32H464c17.7 0 32-14.3 32-32V64c0-17.7-14.3-32-32-32s-32 14.3-32 32v51.2L414.4 97.6c-87.5-87.5-229.3-87.5-316.8 0C73.2 122 55.6 150.7 44.8 181.4c-5.9 16.7 2.9 34.9 19.5 40.8s34.9-2.9 40.8-19.5zM39 289.4c-7.7 21.8-20.2 42.3-37.8 59.8c-62.5 62.5-163.8 62.5-226.3 0l-17.1-17.1H336c17.7 0 32-14.3 32-32s-14.3-32-32-32H336c-17.7 0-32 14.3-32 32v128c0 17.7 14.3 32 32 32s32-14.3 32-32V396.8l17.1 17.1c87.5 87.5 229.3 87.5 316.8 0c24.4-24.4 42.1-53.1 52.9-83.7c5.9-16.7-2.9-34.9-19.5-40.8s-34.9 2.9-40.8 19.5z"/></svg>
                            RESET
                        </button>
                    </div>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-9">
                        <textarea 
                          id="targetInput"
                          class="form-control matrix-input" 
                          rows="1"
                          placeholder="google.com, 1.1.1.1, sub.domain.tld ..."
                          title="Enter domain names or IP addresses separated by commas"
                          required></textarea>
                    </div>
                    <div class="col-md-3">
                        <button onclick="startQuery()" class="btn btn-danger w-100 fw-bold h-100" title="Start multi-vector diagnostic scan for all listed targets">
                            <svg style="width:14px;height:14px;margin-right:8px;fill:currentColor" viewBox="0 0 448 512"><path d="M349.4 44.6c5.9-13.7 1.5-29.7-10.6-38.5s-28.6-8-39.9 1.8l-256 224c-10 8.8-13.6 22.9-8.9 35.3S50.7 288 64 288H175.5L98.6 467.4c-5.9 13.7-1.5 29.7 10.6 38.5s28.6 8 39.9-1.8l256-224c10-8.8 13.6-22.9 8.9-35.3s-16.6-20.7-30-20.7H272.5L349.4 44.6z"/></svg> INITIATE SCAN
                        </button>
                    </div>
                </div>
                
                <div class="mt-4 pt-3 border-top border-secondary opacity-25">
                    <div class="d-flex flex-wrap gap-2">
                        <div class="feature-toggle" title="Retrieve WHOIS ownership and registration data">
                            <input type="checkbox" id="cfg-whois" {{ if .config.EnableWhois }}checked{{ end }}>
                            <label for="cfg-whois"><svg style="width:12px;height:12px;margin-right:4px;fill:currentColor;opacity:0.5" viewBox="0 0 576 512"><path d="M0 96l576 0c0-35.3-28.7-64-64-64L64 32C28.7 32 0 60.7 0 96zm0 32V416c0 35.3 28.7 64 64 64H512c35.3 0 64-28.7 64-64V128H0zM128 224a64 64 0 1 1 128 0 64 64 0 1 1 -128 0zM48 352c0-35.3 28.7-64 64-64H208c35.3 0 64 28.7 64 64v32H48V352zM480 336c0 8.8-7.2 16-16 16H336c-8.8 0-16-7.2-16-16s7.2-16 16-16h128c8.8 0 16 7.2 16 16zm0-64c0 8.8-7.2 16-16 16H336c-8.8 0-16-7.2-16-16s7.2-16 16-16h128c8.8 0 16 7.2 16 16zm0-64c0 8.8-7.2 16-16 16H336c-8.8 0-16-7.2-16-16s7.2-16 16-16h128c8.8 0 16 7.2 16 16z"/></svg>WHOIS</label>
                        </div>
                        <div class="feature-toggle" title="Resolve common DNS records (A, MX, TXT, etc.)">
                            <input type="checkbox" id="cfg-dns" {{ if .config.EnableDNS }}checked{{ end }}>
                            <label for="cfg-dns"><svg style="width:12px;height:12px;margin-right:4px;fill:currentColor;opacity:0.5" viewBox="0 0 512 512"><path d="M64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64zM96 96H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H96c-17.7 0-32-14.3-32-32s14.3-32 32-32zm0 96H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H96c-17.7 0-32-14.3-32-32s14.3-32 32-32zm32 160a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/></svg>DNS</label>
                        </div>
                        <div class="feature-toggle" title="Brute-force common subdomain prefixes">
                            <input type="checkbox" id="cfg-subdomains">
                            <label for="cfg-subdomains"><svg style="width:12px;height:12px;margin-right:4px;fill:currentColor;opacity:0.5" viewBox="0 0 448 512"><path d="M160 80c0-26.5 21.5-48 48-48h32c26.5 0 48 21.5 48 48V432c0 26.5-21.5 48-48 48H208c-26.5 0-48-21.5-48-48V80zM0 272c0-26.5 21.5-48 48-48H80c26.5 0 48 21.5 48 48V432c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V272zM368 224c26.5 0 48 21.5 48 48V432c0 26.5-21.5 48-48 48H336c-26.5 0-48-21.5-48-48V272c0-26.5 21.5-48 48-48h32z"/></svg>PREFIXES</label>
                        </div>
                        <div class="feature-toggle" title="Scan for SSL/TLS certificate validity and configuration">
                            <input type="checkbox" id="cfg-ssl" {{ if .config.EnableSSL }}checked{{ end }}>
                            <label for="cfg-ssl"><svg style="width:12px;height:12px;margin-right:4px;fill:currentColor;opacity:0.5" viewBox="0 0 448 512"><path d="M144 144v48H304V144c0-44.2-35.8-80-80-80s-80 35.8-80 80zM80 192V144C80 64.5 144.5 0 224 0s144 64.5 144 144v48h16c35.3 0 64 28.7 64 64V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V256c0-35.3 28.7-64 64-64H80z"/></svg>SSL/TLS</label>
                        </div>
                        <div class="feature-toggle" title="Inspect HTTP headers and security policies">
                            <input type="checkbox" id="cfg-http" {{ if .config.EnableHTTP }}checked{{ end }}>
                            <label for="cfg-http"><svg style="width:12px;height:12px;margin-right:4px;fill:currentColor;opacity:0.5" viewBox="0 0 512 512"><path d="M0 96C0 60.7 28.7 32 64 32H448c35.3 0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V96zm64 64V416H448V160H64zm32 24c0-13.3 10.7-24 24-24h64c13.3 0 24 10.7 24 24s-10.7 24-24 24H120c-13.3 0-24-10.7-24-24zm160 0c0-13.3 10.7-24 24-24h64c13.3 0 24 10.7 24 24s-10.7 24-24 24H280c-13.3 0-24-10.7-24-24z"/></svg>HTTP</label>
                        </div>
                        <div class="feature-toggle" title="Locate IP physical origin and ASN owner">
                            <input type="checkbox" id="cfg-geo" {{ if .config.EnableGeo }}checked{{ end }}>
                            <label for="cfg-geo"><svg style="width:12px;height:12px;margin-right:4px;fill:currentColor;opacity:0.5" viewBox="0 0 512 512"><path d="M57.7 193l9.4 16.4c8.3 14.5 21.9 25.2 38 29.8L163 255.7c17.2 4.9 29 20.6 29 38.5v39.9c0 11 6.2 21 16 25.9s16 14.9 16 25.9v39c0 15.6 14.9 26.9 29.9 22.6c16.1-4.6 28.6-17.5 32.7-33.8l2.8-11.2c4.2-16.9 15.2-31.4 30.3-40l8.1-4.6c15-8.5 24.2-24.5 24.2-41.7v-8.3c0-12.7-5.1-24.9-14.1-33.9l-3.9-3.9c-9-9-21.2-14.1-33.9-14.1H257c-11.1 0-22.1-2.9-31.8-8.4l-34.5-19.7c-4.3-2.5-7.6-6.5-9.2-11.2l-3.2-9.6c-1.1-3.3-3.1-6.2-5.8-8.5L142 171.2c-7.9-6.7-11.7-17.3-9.9-27.6l3.2-18.8c1.7-10.2-1.7-20.4-9.3-27.3l-3.6-3.3c-15.9-14.4-40-13-54.2 3.3L13 161.5C3 173 1.3 189.3 8.8 202.5l4.1 7.1c7.1 12.3 18.1 22.2 31.3 28l13.5 6zM497 273.9c4.9-18.2 1.3-37.5-9.8-52.5l-7.1-9.4c-23.4-31.2-64.1-41.3-99.2-24.4l-30 14.4c-15.6 7.5-25.6 23.3-25.6 40.7v57.4c0 16.9 9.1 32.6 24 41.2l62.7 36c13.2 7.6 27.3 12.7 42 15.1l15 2.5c10.3 1.7 20.4-2.1 27-9.8l14.9-17.6c12.7-14.9 15.3-35.6 6.9-53.1l-1.1-2.4zM256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512z"/></svg>GEO/ASN</label>
                        </div>
                        <div class="feature-toggle" title="Search Certificate Transparency logs for historical subdomains">
                            <input type="checkbox" id="cfg-ct" {{ if .config.EnableCT }}checked{{ end }}>
                            <label for="cfg-ct"><svg style="width:12px;height:12px;margin-right:4px;fill:currentColor;opacity:0.5" viewBox="0 0 512 512"><path d="M75 75L41 109c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0L109 109c9.4-9.4 9.4-24.6 0-33.9s-24.6-9.4-33.9 0zM503 7c-9.4-9.4-24.6-9.4-33.9 0L435 41c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0L503 41c9.4-9.4 9.4-24.6 0-33.9zM9 403c-9.4 9.4-9.4 24.6 0 33.9l34 34c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-34-34c-9.4-9.4-24.6-9.4-33.9 0zM437 437c-9.4 9.4-9.4 24.6 0 33.9l34 34c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-34-34c-9.4-9.4-24.6-9.4-33.9 0zM256 160c-53 0-96 43-96 96s43 96 96 96s96-43 96-96s-43-96-96-96zm0 256c-88.4 0-160-71.6-160-160s71.6-160 160-160s160 71.6 160 160s-71.6 160-160 160z"/></svg>CT LOGS</label>
                        </div>
                        <div class="feature-toggle" title="Perform real-time ICMP ping to check availability and latency">
                            <input type="checkbox" id="cfg-ping">
                            <label for="cfg-ping"><svg style="width:12px;height:12px;margin-right:4px;fill:currentColor;opacity:0.5" viewBox="0 0 640 512"><path d="M352 128c0 17.7-14.3 32-32 32s-32-14.3-32-32s14.3-32 32-32s32 14.3 32 32zm96 96c0 17.7-14.3 32-32 32s-32-14.3-32-32s14.3-32 32-32s32 14.3 32 32zm96 96c0 17.7-14.3 32-32 32s-32-14.3-32-32s14.3-32 32-32s32 14.3 32 32zM128 352c0 17.7-14.3 32-32 32s-32-14.3-32-32s14.3-32 32-32s32 14.3 32 32z"/></svg>PING</label>
                        </div>
                        <div class="feature-toggle" title="Execute recursive DNS trace from root servers">
                            <input type="checkbox" id="cfg-trace">
                            <label for="cfg-trace"><svg style="width:12px;height:12px;margin-right:4px;fill:currentColor;opacity:0.5" viewBox="0 0 512 512"><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zm50.7-186.9L204 328c-10.1 2.5-18.4 10.1-20.9 20.2L171.1 404c-2.4 9.7-13.1 14.3-21.7 9.3s-9.8-15.3-2.4-22.1l102.7-94.3c10.1-9.3 25.1-9.3 35.2 0l102.7 94.3c7.4 6.8 6.2 17.1-2.4 22.1s-19.3 .4-21.7-9.3l-12-55.9z"/></svg>TRACE</label>
                        </div>
                        <div class="feature-toggle" title="Perform standard traceroute to identify network hops">
                            <input type="checkbox" id="cfg-route">
                            <label for="cfg-route"><svg style="width:12px;height:12px;margin-right:4px;fill:currentColor;opacity:0.5" viewBox="0 0 512 512"><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 209c-13.3 0-24 10.7-24 24s10.7 24 24 24l128 0c13.3 0 24-10.7 24-24s-10.7-24-24-24zM143 303c-13.3 0-24 10.7-24 24s10.7 24 24 24l128 0c13.3 0 24-10.7 24-24s-10.7-24-24-24L143 303z"/></svg>ROUTE</label>
                        </div>
                        <div class="feature-toggle" title="Scan for open TCP ports (IPs only, max 10 ports)">
                            <input type="checkbox" id="cfg-portscan">
                            <label for="cfg-portscan"><svg style="width:12px;height:12px;margin-right:4px;fill:currentColor;opacity:0.5" viewBox="0 0 576 512"><path d="M320 32c0-17.7-14.3-32-32-32s-32 14.3-32 32V288c0 17.7 14.3 32 32 32s32-14.3 32-32V32zM448 160c0-17.7-14.3-32-32-32s-32 14.3-32 32V288c0 17.7 14.3 32 32 32s32-14.3 32-32V160zM64 288c0 17.7 14.3 32 32 32s32-14.3 32-32V160c0-17.7-14.3-32-32-32s-32 14.3-32 32V288zM192 32c0-17.7-14.3-32-32-32s-32 14.3-32 32V416c0 17.7 14.3 32 32 32s32-14.3 32-32V32z"/></svg>PORTSCAN <svg style="width:12px;height:12px;fill:currentColor;opacity:0.5" viewBox="0 0 512 512" class="help-icon" data-tippy-content="Port scanning is only supported for direct IP addresses (skipped for domains)."><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/></svg></label>
                        </div>
                        <div id="portsInputWrapper" style="display:none; margin-top: -5px;">
                            <input type="text" id="cfg-ports" class="form-control matrix-input py-1" style="font-size: 0.7rem; width: 140px;" value="80,443,22,21,3389" placeholder="Specific ports...">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workspace Area -->
        <div id="resultsGrid" class="results-grid">
            <!-- Widgets injected here -->
        </div>
    </div>

    <!-- Quick Tools & Side Info -->
    <div class="col-xl-4">
        <div class="glass-panel border-nordic mb-4 p-4">
            <h5 class="fw-bold mb-3">
                <svg style="width:16px;height:16px;margin-right:8px;fill:#ffc107" viewBox="0 0 512 512"><path d="M448 32c0-17.7-14.3-32-32-32s-32 14.3-32 32V128H320c-17.7 0-32 14.3-32 32s14.3 32 32 32h64v32H224c-17.7 0-32 14.3-32 32s14.3 32 32 32h32v64c0 17.7 14.3 32 32 32s32-14.3 32-32V320h64c17.7 0 32-14.3 32-32s-14.3-32-32-32H320V224h64c17.7 0 32-14.3 32-32s-14.3-32-32-32H352V32h96z"/></svg>
                QUICK TOOLS
            </h5>
            <div class="list-group list-group-flush bg-transparent">
                <a href="#" onclick="openTool('dns')" class="list-group-item bg-transparent text-muted border-secondary py-3 d-flex justify-content-between align-items-center" title="Open single-target DNS lookup tool">
                    <span><svg style="width:14px;height:14px;margin-right:12px;fill:#0dcaf0" viewBox="0 0 512 512"><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z"/></svg> SINGLE DNS LOOKUP</span>
                    <svg style="width:10px;height:10px;opacity:0.5;fill:currentColor" viewBox="0 0 320 512"><path d="M310.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L242.7 256 73.4 82.7c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l192 192z"/></svg>
                </a>
                <a href="#" onclick="openTool('mac')" class="list-group-item bg-transparent text-muted border-secondary py-3 d-flex justify-content-between align-items-center" title="Open MAC address vendor lookup tool">
                    <span><svg style="width:14px;height:14px;margin-right:12px;fill:#ffc107" viewBox="0 0 512 512"><path d="M0 80V432c0 26.5 21.5 48 48 48H464c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48H48C21.5 32 0 53.5 0 80zM64 96H96v320H64V96zm64 0h32v320H128V96zM224 96h64V416H224V96zm96 0h32v320H320V96zm64 0h32v320H384V96zm64 0h32v320H448V96z"/></svg> MAC VENDOR LOOKUP</span>
                    <svg style="width:10px;height:10px;opacity:0.5;fill:currentColor" viewBox="0 0 320 512"><path d="M310.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L242.7 256 73.4 82.7c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l192 192z"/></svg>
                </a>
                <a href="/metrics" target="_blank" class="list-group-item bg-transparent text-muted border-0 py-3 d-flex justify-content-between align-items-center" title="View real-time system and application metrics">
                    <span><svg style="width:14px;height:14px;margin-right:12px;fill:#ff4d4d" viewBox="0 0 640 512"><path d="M0 64C0 28.7 28.7 0 64 0H576c35.3 0 64 28.7 64 64V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V64zm384 64c-17.7 0-32 14.3-32 32s14.3 32 32 32h64c17.7 0 32-14.3 32-32s-14.3-32-32-32H384zm0 128c-17.7 0-32 14.3-32 32s14.3 32 32 32h64c17.7 0 32-14.3 32-32s-14.3-32-32-32H384zm0 128c-17.7 0-32 14.3-32 32s14.3 32 32 32h64c17.7 0 32-14.3 32-32s-14.3-32-32-32H384zM64 128c-17.7 0-32 14.3-32 32s14.3 32 32 32s32-14.3 32-32s-14.3-32-32-32zm96 0c-17.7 0-32 14.3-32 32s14.3 32 32 32s32-14.3 32-32s-14.3-32-32-32zm96 0c-17.7 0-32 14.3-32 32s14.3 32 32 32s32-14.3 32-32s-14.3-32-32-32zm96 0c-17.7 0-32 14.3-32 32s14.3 32 32 32s32-14.3 32-32s-14.3-32-32-32z"/></svg> SYSTEM METRICS</span>
                    <svg style="width:10px;height:10px;opacity:0.5;fill:currentColor" viewBox="0 0 512 512"><path d="M320 0c-17.7 0-32 14.3-32 32s14.3 32 32 32h82.7L201.4 265.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L448 109.3V192c0 17.7 14.3 32 32 32s32-14.3 32-32V32c0-17.7-14.3-32-32-32H320zM80 32C35.8 32 0 67.8 0 112V432c0 44.2 35.8 80 80 80H400c44.2 0 80-35.8 80-80V320c0-17.7-14.3-32-32-32s-32 14.3-32 32V432c0 8.8-7.2 16-16 16H80c-8.8 0-16-7.2-16-16V112c0-8.8 7.2-16 16-16H192c17.7 0 32-14.3 32-32s-14.3-32-32-32H80z"/></svg>
                </a>
            </div>
        </div>

        <div class="glass-panel border-nordic mb-4 p-3">
            <h6 class="text-muted small border-bottom border-secondary pb-2 mb-3">
                <svg style="width:14px;height:14px;margin-right:8px;fill:#0dcaf0" viewBox="0 0 448 512"><path d="M160 80c0-26.5 21.5-48 48-48h32c26.5 0 48 21.5 48 48V432c0 26.5-21.5 48-48 48H208c-26.5 0-48-21.5-48-48V80zM0 272c0-26.5 21.5-48 48-48H80c26.5 0 48 21.5 48 48V432c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V272zM368 224c26.5 0 48 21.5 48 48V432c0 26.5-21.5 48-48 48H336c-26.5 0-48-21.5-48-48V272c0-26.5 21.5-48 48-48h32z"/></svg>
                SYSTEM STATISTICS
            </h6>
            <div class="row text-center">
                <div class="col-6 border-end border-secondary border-opacity-25">
                    <div class="h4 mb-0 text-nordic-blue fw-bold">{{ .stats.MonitoredCount }}</div>
                    <div class="text-muted" style="font-size: 0.6rem; letter-spacing: 1px;">MONITORED</div>
                </div>
                <div class="col-6">
                    <div class="h4 mb-0 text-nordic-blue fw-bold">{{ .stats.HistoryCount }}</div>
                    <div class="text-muted" style="font-size: 0.6rem; letter-spacing: 1px;">HISTORY</div>
                </div>
            </div>
        </div>

        <div class="glass-panel border-nordic mb-4 h-100 p-3" style="min-height: 400px; display: flex; flex-direction: column;">
            <h6 class="text-muted small border-bottom border-secondary pb-2 mb-3">
                <svg style="width:14px;height:14px;margin-right:8px;fill:#ff4d4d" viewBox="0 0 512 512"><path d="M192 128a64 64 0 1 0 128 0 64 64 0 1 0 -128 0zm157.6 12c-8.3-14-19-26.8-31.3-38.1c-13.1-12.1-28.1-21.8-44.3-28.6c-5.9-2.5-12.5-3.8-19.2-3.8s-13.3 1.3-19.2 3.8c-16.2 6.8-31.2 16.5-44.3 28.6c-12.3 11.3-23 24.1-31.3 38.1c-13.1 22.1-19.7 47.1-19.7 73.1c0 33.7 11.4 69.4 31.7 98.2c18.8 26.6 44.2 44.7 72.2 53.9c6.3 2.1 13 3.2 19.8 3.2s13.5-1.1 19.8-3.2c28-9.2 53.4-27.3 72.2-53.9c20.3-28.8 31.7-64.5 31.7-98.2c0-26-6.6-51-19.7-73.1zM352 128c0 53-43 96-96 96s-96-43-96-96s43-96 96-96s96 43 96 96zm128 0c0 123.7-100.3 224-224 224S32 251.7 32 128S132.3-96 256-96s224 100.3 224 224zM256 448c-17.7 0-32 14.3-32 32s14.3 32 32 32s32-14.3 32-32s-14.3-32-32-32z"/></svg>
                LIVE ACTIVITY
            </h6>
            <div id="liveLog" class="flex-grow-1 font-monospace" style="font-size: 0.7rem; overflow-y: auto; max-height: 600px;">
                <div class="text-muted italic">Waiting for scan data...</div>
            </div>
        </div>
    </div>
</div>

<template id="resultCardTemplate">
    <div class="result-card glass-panel" data-target="" draggable="true">
        <div class="card-handle" title="Drag to reorder widgets">
            <div class="d-flex align-items-center gap-2">
                <svg style="width:12px;height:12px;fill:currentColor;opacity:0.5" viewBox="0 0 320 512"><path d="M40 352a40 40 0 1 0 0 80 40 40 0 1 0 0-80zm0-160a40 40 0 1 0 0 80 40 40 0 1 0 0-80zm0-160a40 40 0 1 0 0 80 40 40 0 1 0 0-80zm160 320a40 40 0 1 0 0 80 40 40 0 1 0 0-80zm0-160a40 40 0 1 0 0 80 40 40 0 1 0 0-80zm0-160a40 40 0 1 0 0 80 40 40 0 1 0 0-80z"/></svg>
            </div>
            <button class="btn btn-link btn-sm text-muted p-0" onclick="this.closest('.result-card').remove()" title="Close widget">
                <svg style="width:12px;height:12px;fill:currentColor" viewBox="0 0 384 512"><path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/></svg>
            </button>
        </div>
        <div class="d-flex justify-content-between align-items-start mb-3 p-3">
            <h5 class="target-name mb-0 font-monospace text-danger"></h5>
            <div class="d-flex gap-2 align-items-center">
                <span class="badge bg-nordic-blue-dim text-nordic-blue small status-badge">pending</span>
                <svg style="width:14px;height:14px;fill:currentColor;cursor:pointer" onclick="fetchHistory(this)" viewBox="0 0 512 512" title="View History"><path d="M75 75L41 109c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0L109 109c9.4-9.4 9.4-24.6 0-33.9s-24.6-9.4-33.9 0zM503 7c-9.4-9.4-24.6-9.4-33.9 0L435 41c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0L503 41c9.4-9.4 9.4-24.6 0-33.9zM9 403c-9.4 9.4-9.4 24.6 0 33.9l34 34c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-34-34c-9.4-9.4-24.6-9.4-33.9 0zM437 437c-9.4 9.4-9.4 24.6 0 33.9l34 34c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-34-34c-9.4-9.4-24.6-9.4-33.9 0zM256 160c-53 0-96 43-96 96s43 96 96 96s96-43 96-96s-43-96-96-96zm0 256c-88.4 0-160-71.6-160-160s71.6-160 160-160s160 71.6 160 160s-71.6 160-160 160z"/></svg>
                <svg style="width:14px;height:14px;fill:currentColor;cursor:pointer" onclick="reScanTarget(this)" viewBox="0 0 512 512" title="Rescan"><path d="M105.1 202.6c7.7-21.8 20.2-42.3 37.8-59.8c62.5-62.5 163.8-62.5 226.3 0L386.3 160H336c-17.7 0-32 14.3-32 32s14.3 32 32 32H464c17.7 0 32-14.3 32-32V64c0-17.7-14.3-32-32-32s-32 14.3-32 32v51.2L414.4 97.6c-87.5-87.5-229.3-87.5-316.8 0C73.2 122 55.6 150.7 44.8 181.4c-5.9 16.7 2.9 34.9 19.5 40.8s34.9-2.9 40.8-19.5zM39 289.4c-7.7 21.8-20.2 42.3-37.8 59.8c-62.5 62.5-163.8 62.5-226.3 0l-17.1-17.1H336c17.7 0 32-14.3 32-32s-14.3-32-32-32H336c-17.7 0-32 14.3-32 32v128c0 17.7 14.3 32 32 32s32-14.3 32-32V396.8l17.1 17.1c87.5 87.5 229.3 87.5 316.8 0c24.4-24.4 42.1-53.1 52.9-83.7c5.9-16.7-2.9-34.9-19.5-40.8s-34.9 2.9-40.8 19.5z"/></svg>
                <svg style="width:14px;height:14px;fill:currentColor;cursor:pointer" onclick="copyTarget(this)" viewBox="0 0 448 512" title="Copy Full Result"><path d="M208 0H332.1c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9V336c0 26.5-21.5 48-48 48H208c-26.5 0-48-21.5-48-48V48c0-26.5 21.5-48 48-48zM48 128h80v64H64V448H256V416h64v48c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V176c0-26.5 21.5-48 48-48z"/></svg>
                <div class="streaming-indicator"></div>
            </div>
        </div>
        <div class="progress mx-3 mb-3" style="height: 2px; background: var(--glass-border);">
            <div class="progress-bar bg-danger" role="progressbar" style="width: 0%"></div>
        </div>
        <div class="diagnostic-content p-3 pt-0">
            <div class="service-section" data-service="geo"></div>
            <div class="service-section" data-service="whois"></div>
            <div class="service-section" data-service="dns"></div>
            <div class="service-section" data-service="subdomains"></div>
            <div class="service-section" data-service="portscan"></div>
            <div class="service-section" data-service="ping"></div>
            <div class="service-section" data-service="route"></div>
            <div class="service-section" data-service="trace"></div>
            <div class="service-section" data-service="ssl"></div>
            <div class="service-section" data-service="http"></div>
            <div class="service-section" data-service="ct"></div>
        </div>
    </div>
</template>

<script>
let socket;
const activeScans = new Map();

function connectWS() {
    const proto = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    socket = new WebSocket(`${proto}//${window.location.host}/ws`);
    
    socket.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        updateUI(msg);
    };

    socket.onclose = () => {
        console.log("Socket closed. Reconnecting...");
        setTimeout(connectWS, 2000);
    };
}

function appendLog(target, message) {
    const log = document.getElementById('liveLog');
    const time = new Date().toLocaleTimeString();
    const entry = document.createElement('div');
    entry.className = "mb-1";
    entry.innerHTML = `<span class="text-muted">[${time}]</span> <span class="text-danger">${target}</span>: ${message}`;
    log.appendChild(entry);
    log.scrollTop = log.scrollHeight;
    
    // Remove "Waiting" message if present
    const waiting = log.querySelector('.italic');
    if (waiting) waiting.remove();
}

function startQuery() {
    const targets = document.getElementById('targetInput').value.split(',').map(t => t.trim()).filter(t => t !== "");
    if (targets.length === 0) return;

    const isIP = (str) => {
        const regex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$|^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/;
        return regex.test(str);
    };

    targets.forEach(t => {
        const targetIsIP = isIP(t);
        const config = {
            whois: document.getElementById('cfg-whois').checked,
            dns: document.getElementById('cfg-dns').checked,
            ssl: document.getElementById('cfg-ssl').checked,
            http: document.getElementById('cfg-http').checked,
            geo: document.getElementById('cfg-geo').checked,
            ct: document.getElementById('cfg-ct').checked,
            ping: document.getElementById('cfg-ping').checked,
            trace: document.getElementById('cfg-trace').checked,
            route: document.getElementById('cfg-route').checked,
            subdomains: document.getElementById('cfg-subdomains').checked,
            portscan: document.getElementById('cfg-portscan').checked && targetIsIP,
            ports: document.getElementById('cfg-portscan').checked ? document.getElementById('cfg-ports').value : "",
        };

        const enabledServices = Object.values(config).filter(v => v && v !== "").length;

        createCard(t);
        activeScans.set(t, {
            total: enabledServices,
            completed: 0
        });
        updateProgressBar(t);
        socket.send(JSON.stringify({ targets: [t], config }));
    });
}

function getDragAfterElement(container, x, y) {
    const draggableElements = [...container.querySelectorAll('.result-card:not(.dragging)')];

    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offsetX = x - box.left - box.width / 2;
        const offsetY = y - box.top - box.height / 2;
        const distance = Math.sqrt(offsetX * offsetX + offsetY * offsetY);
        
        if (distance < closest.distance) {
            return { distance: distance, element: child };
        } else {
            return closest;
        }
    }, { distance: Number.POSITIVE_INFINITY }).element;
}

function createCard(target) {
    let card = document.querySelector(`[data-target="${target}"]`);
    if (card) {
        card.remove(); // Re-create for fresh scan
    }

    const template = document.getElementById('resultCardTemplate');
    const clone = template.content.cloneNode(true);
    card = clone.querySelector('.result-card');
    
    card.setAttribute('data-target', target);
    card.querySelector('.target-name').innerText = target;
    
    // Drag Events
    card.addEventListener('dragstart', (e) => {
        card.classList.add('dragging');
        e.dataTransfer.setData('text/plain', target);
    });

    card.addEventListener('dragend', () => {
        card.classList.remove('dragging');
    });

    const resultsGrid = document.getElementById('resultsGrid');
    resultsGrid.addEventListener('dragover', (e) => {
        e.preventDefault();
        const draggable = document.querySelector('.dragging');
        if (!draggable) return;
        
        const afterElement = getDragAfterElement(resultsGrid, e.clientX, e.clientY);
        if (afterElement == null) {
            resultsGrid.appendChild(draggable);
        } else {
            resultsGrid.insertBefore(draggable, afterElement);
        }
    });

    const isIP = (str) => {
        const regex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$|^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/;
        return regex.test(str);
    };
    const targetIsIP = isIP(target);

    // Add skeletons to enabled services
    const config = {
        whois: document.getElementById('cfg-whois').checked,
        dns: document.getElementById('cfg-dns').checked,
        ssl: document.getElementById('cfg-ssl').checked,
        http: document.getElementById('cfg-http').checked,
        geo: document.getElementById('cfg-geo').checked,
        ct: document.getElementById('cfg-ct').checked,
        ping: document.getElementById('cfg-ping').checked,
        trace: document.getElementById('cfg-trace').checked,
        route: document.getElementById('cfg-route').checked,
        portscan: document.getElementById('cfg-portscan').checked && targetIsIP,
        subdomains: document.getElementById('cfg-subdomains').checked,
    };

    for (const [service, enabled] of Object.entries(config)) {
        if (enabled) {
            const section = card.querySelector(`[data-service="${service}"]`);
            if (section) {
                section.innerHTML = `
                    <div class="skeleton-wrapper p-2">
                        <div class="skeleton mb-2" style="height: 12px; width: 40%"></div>
                        <div class="skeleton" style="height: 8px; width: 80%"></div>
                    </div>`;
            }
        }
    }

    document.getElementById('resultsGrid').prepend(card);
    
    // Initialize tooltips for the new card
    tippy(card.querySelectorAll('[title]'), { theme: 'matrix' });
}

function updateProgressBar(target) {
    const card = document.querySelector(`[data-target="${target}"]`);
    if (!card) return;

    const scan = activeScans.get(target);
    if (!scan) return;

    const percent = (scan.completed / scan.total) * 100;
    const bar = card.querySelector('.progress-bar');
    bar.style.width = `${percent}%`;

    const statusBadge = card.querySelector('.status-badge');
    if (scan.completed === scan.total) {
        statusBadge.innerText = "completed";
        statusBadge.classList.replace('bg-nordic-blue-dim', 'bg-success-dim');
        statusBadge.classList.replace('text-nordic-blue', 'text-success');
        card.querySelector('.streaming-indicator').style.display = 'none';
    } else {
        statusBadge.innerText = "scanning...";
    }
}

function updateUI(msg) {
    if (msg.type === 'log') {
        appendLog(msg.target, msg.data);
        return;
    }

    if (msg.type === 'done') {
        const scan = activeScans.get(msg.target);
        if (scan) {
            scan.completed++;
            updateProgressBar(msg.target);
        }
        return;
    }

    if (msg.type === 'all_done') {
        const card = document.querySelector(`[data-target="${msg.target}"]`);
        if (card) {
            const bar = card.querySelector('.progress-bar');
            bar.style.width = `100%`;
            const statusBadge = card.querySelector('.status-badge');
            statusBadge.innerText = "completed";
            statusBadge.classList.replace('bg-nordic-blue-dim', 'bg-success-dim');
            statusBadge.classList.replace('text-nordic-blue', 'text-success');
            card.querySelector('.streaming-indicator').style.display = 'none';
        }
        return;
    }

    const card = document.querySelector(`[data-target="${msg.target}"]`);
    if (!card) return;

    const section = card.querySelector(`[data-service="${msg.service}"]`);
    if (!section) return;

    let html = "";
    const data = msg.data;

    switch(msg.service) {
        case 'geo':
            if (data && !data.error) {
                html = `<details open><summary>LOCATION & ASN <svg style="width:12px;height:12px;margin-left:4px;fill:currentColor;opacity:0.5" viewBox="0 0 512 512" class="help-icon" data-tippy-content="Physical location and network owner data"><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/></svg></summary>
                        <div class="p-2 small">
                            <div class="d-flex align-items-center mb-2">
                                <svg style="width:16px;height:16px;margin-right:12px;fill:#ff4d4d" viewBox="0 0 384 512"><path d="M215.7 499.2C267 435 384 279.4 384 192C384 86 298 0 192 0S0 86 0 192c0 87.4 117 243 168.3 307.2c12.3 15.3 35.1 15.3 47.4 0zM192 128a64 64 0 1 1 0 128 64 64 0 1 1 0-128z"/></svg>
                                <div>
                                    <div class="fw-bold">${data.city || 'Unknown City'}, ${data.country}</div>
                                    <div class="text-muted" style="font-size:0.65rem;">${data.timezone || ''}</div>
                                </div>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <svg style="width:16px;height:16px;margin-right:12px;fill:#0dcaf0" viewBox="0 0 640 512"><path d="M640 352c0 35.3-28.7 64-64 64H512V320H640v32zm-192 64H320V320H448v96zm-192 0H64c-35.3 0-64-28.7-64-64V320H192v96zm448-160H0V160c0-35.3 28.7-64 64-64H576c35.3 0 64 28.7 64 64V256zM64 128c-17.7 0-32 14.3-32 32s14.3 32 32 32s32-14.3 32-32s-14.3-32-32-32zm96 0c-17.7 0-32 14.3-32 32s14.3 32 32 32s32-14.3 32-32s-14.3-32-32-32zm96 0c-17.7 0-32 14.3-32 32s14.3 32 32 32s32-14.3 32-32s-14.3-32-32-32zm96 0c-17.7 0-32 14.3-32 32s14.3 32 32 32s32-14.3 32-32s-14.3-32-32-32zm96 0c-17.7 0-32 14.3-32 32s14.3 32 32 32s32-14.3 32-32s-14.3-32-32-32zm96 0c-17.7 0-32 14.3-32 32s14.3 32 32 32s32-14.3 32-32s-14.3-32-32-32z"/></svg>
                                <div>
                                    <div class="fw-bold">${data.as || 'Unknown AS'}</div>
                                    <div class="text-muted" style="font-size:0.65rem;">IP: ${data.query}</div>
                                </div>
                            </div>
                            <div class="mt-2 pt-2 border-top border-secondary opacity-25">
                                <div class="text-muted" style="font-size:0.6rem; letter-spacing:1px;">COORDINATES: ${data.lat}, ${data.lon}</div>
                            </div>
                        </div></details>`;
            } else {
                html = `<details><summary>LOCATION & ASN</summary><div class="p-2 text-muted small">Geo data unavailable</div></details>`;
            }
            break;
        case 'subdomains':
            if (data && Object.keys(data).length > 0) {
                html = `<details open><summary>SUBDOMAIN DISCOVERY <svg style="width:12px;height:12px;margin-left:4px;fill:currentColor;opacity:0.5" viewBox="0 0 512 512" class="help-icon" data-tippy-content="Brute-forced common prefixes"><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/></svg></summary>
                        <div class="p-2 small">
`;
                for (const [fqdn, records] of Object.entries(data)) {
                    html += `<div class="mb-2 pb-1 border-bottom border-secondary opacity-25">
                                <div class="text-danger fw-bold clickable-record" onclick="copyToClipboard(this)">${fqdn}</div>
                                <div class="ps-2">
`;
                    for (const [type, vals] of Object.entries(records)) {
                        html += `<div class="text-white" style="font-size: 0.65rem;"><span class="text-info">${type}:</span> <span class="subdomain-item clickable-record" onclick="copyToClipboard(this)">${vals.join(', ')}</span></div>`;
                    }
                    html += `</div></div>`;
                }
                html += `</div></details>`;
            } else {
                html = `<details><summary>SUBDOMAIN DISCOVERY</summary><div class="p-2 text-white small">No common subdomains found</div></details>`;
            }
            break;
        case 'portscan':
            if (data && Object.keys(data).length > 0) {
                html = `<details open><summary>PORT SCAN <svg style="width:12px;height:12px;margin-left:4px;fill:currentColor;opacity:0.5" viewBox="0 0 512 512" class="help-icon" data-tippy-content="Open ports and service banners"><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/></svg></summary>
                        <div class="p-2">
`;
                for (const [port, banner] of Object.entries(data)) {
                    html += `<div class="d-flex justify-content-between align-items-center mb-1 small clickable-record" onclick="copyToClipboard(this)">
                                <span class="badge bg-danger-dim text-danger" style="width: 60px;">${port}</span>
                                <span class="text-info font-monospace flex-grow-1 ms-2" style="font-size: 0.65rem;">${banner || 'Open (No Banner)'}</span>
                             </div>`;
                }
                html += `</div></details>`;
            } else {
                html = `<details><summary>PORT SCAN</summary><div class="p-2 text-muted small">No open ports found</div></details>`;
            }
            break;
        case 'ping':
            html = `<details open><summary>PING ICMP <svg style="width:12px;height:12px;margin-left:4px;fill:currentColor;opacity:0.5" viewBox="0 0 512 512" class="help-icon" data-tippy-content="Real-time latency check"><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/></svg></summary>
                    <pre class="p-2 mt-1 rounded bg-dark text-success clickable-record" onclick="copyToClipboard(this)" style="font-size: 0.7rem; min-height: 60px;"><code>${data.join('\n')}</code></pre>
                    </details>`;
            break;
        case 'route':
            html = `<details><summary>TRACEROUTE <svg style="width:12px;height:12px;margin-left:4px;fill:currentColor;opacity:0.5" viewBox="0 0 512 512" class="help-icon" data-tippy-content="Network hop analysis"><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/></svg></summary>
                    <pre class="p-2 mt-1 rounded bg-dark text-info clickable-record" onclick="copyToClipboard(this)" style="font-size: 0.7rem; min-height: 60px;"><code>${data.join('\n')}</code></pre>
                    </details>`;
            break;
        case 'trace':
            html = `<details><summary>DNS TRACE <svg style="width:12px;height:12px;margin-left:4px;fill:currentColor;opacity:0.5" viewBox="0 0 512 512" class="help-icon" data-tippy-content="Recursive resolution from root"><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/></svg></summary>
                    <pre class="p-2 mt-1 rounded clickable-record" onclick="copyToClipboard(this)" style="font-size: 0.7rem;"><code>${data.join('\n')}</code></pre>
                    </details>`;
            break;
        case 'dns':
            if (data && data.error) {
                html = `<details><summary>DNS RECORDS</summary><div class="p-2 text-danger small">${data.error}</div></details>`;
            } else if (data && Object.keys(data).length > 0) {
                html = `<details open><summary>DNS RECORDS <svg style="width:12px;height:12px;margin-left:4px;fill:currentColor;opacity:0.5" viewBox="0 0 512 512" class="help-icon" data-tippy-content="A, MX, TXT and other zone records"><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/></svg></summary>
                        <div class="p-2 small">`;
                for (const [type, val] of Object.entries(data)) {
                    html += `<div class="mb-2 pb-1 border-bottom border-secondary opacity-25">
                                <div class="text-info fw-bold small">${type}</div>
                                <div class="ps-2">`;
                    if (Array.isArray(val)) {
                        val.forEach(v => {
                            html += `<div class="text-white clickable-record" onclick="copyToClipboard(this)">${v}</div>`;
                        });
                    } else if (type === "Subdomains") {
                        html += `<div class="text-white italic">Found ${Object.keys(val).length} prefixes</div>`;
                    } else {
                        html += `<div class="text-white clickable-record" onclick="copyToClipboard(this)">${JSON.stringify(val)}</div>`;
                    }
                    html += `</div></div>`;
                }
                html += `</div></details>`;
            } else {
                html = `<details><summary>DNS RECORDS</summary><div class="p-2 text-white small">No records found</div></details>`;
            }
            break;
        case 'ssl':
            if (data.error) {
                html = `<details><summary>SSL/TLS</summary><div class="p-2 text-muted small">${data.error}</div></details>`;
            } else {
                html = `<details><summary>SSL/TLS <svg style="width:12px;height:12px;margin-left:4px;fill:currentColor;opacity:0.5" viewBox="0 0 512 512" class="help-icon" data-tippy-content="TLS Handshake and Certificate Validity"><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/></svg></summary>
                        <div class="p-2 small">
                            <span class="badge bg-success mb-2">${data.protocol}</span><br>
                            <span class="clickable-record" onclick="copyToClipboard(this)"><strong>Issuer:</strong> ${data.issuer}</span><br>
                            <span class="clickable-record" onclick="copyToClipboard(this)"><strong>Expiry:</strong> ${data.expiry.split('T')[0]} (${data.days_left}d)</span>
                        </div></details>`;
            }
            break;
        case 'http':
            if (data.error) {
                html = `<details><summary>HTTP</summary><div class="p-2 text-muted small">${data.error}</div></details>`;
            } else {
                let securityHtml = "";
                for (const [h, val] of Object.entries(data.security)) {
                    const isSet = val !== "Not Set";
                    securityHtml += `<div class="d-flex justify-content-between mb-1 clickable-record" onclick="copyToClipboard(this)">
                        <span class="text-muted" style="font-size: 0.65rem;">${h}</span>
                        <span class="badge ${isSet ? 'bg-success-dim text-success' : 'bg-danger-dim text-danger'}" style="font-size: 0.6rem;">${isSet ? 'SECURE' : 'MISSING'}</span>
                    </div>`;
                }

                html = `<details><summary>HTTP INSPECTOR <svg style="width:12px;height:12px;margin-left:4px;fill:currentColor;opacity:0.5" viewBox="0 0 512 512" class="help-icon" data-tippy-content="Security headers and response metadata"><path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/></svg></summary>
                        <div class="p-2 small">
                            <div class="d-flex justify-content-between mb-2 align-items-center clickable-record" onclick="copyToClipboard(this)">
                                <strong>Status:</strong> <span class="badge ${data.status.startsWith('2') ? 'bg-success' : 'bg-warning'}">${data.status}</span>
                                <span class="badge bg-dark border border-secondary text-info">${data.response_time_ms}ms</span>
                            </div>
                            <div class="mb-2"><strong>Protocol:</strong> ${data.protocol}</div>
                            <div class="mb-2 clickable-record" onclick="copyToClipboard(this)"><strong>Server:</strong> ${data.headers.Server || 'Unknown'}</div>
                            <div class="security-headers-minimal mb-2">
                                ${securityHtml}
                            </div>
                            <details class="mt-2"><summary><small>FULL HEADERS</small></summary>
                            <pre class="p-2 mt-1 rounded clickable-record" onclick="copyToClipboard(this)" style="font-size: 0.7rem;"><code>${JSON.stringify(data.headers, null, 2)}</code></pre>
                            </details>
                        </div></details>`;
            }
            break;
        case 'whois':
            if (data && typeof data === 'object') {
                html = `<details open><summary>WHOIS DATA</summary>
                        <div class="p-2 small">
                            <div class="clickable-record" onclick="copyToClipboard(this)"><strong>Registrar:</strong> ${data.registrar || 'Unknown'}</div>
                            <div class="clickable-record" onclick="copyToClipboard(this)"><strong>Expires:</strong> ${data.expiry || 'Unknown'}</div>
                            <div class="clickable-record" onclick="copyToClipboard(this)"><strong>Created:</strong> ${data.created || 'Unknown'}</div>
                        </div>
                        <details><summary><small>RAW DATA</small></summary>
                        <pre class="p-2 mt-1 rounded clickable-record" onclick="copyToClipboard(this)"><code>${data.raw}</code></pre>
                        </details></details>`;
            } else if (data) {
                html = `<details><summary>WHOIS RAW</summary><pre class="p-2 mt-1 rounded clickable-record" onclick="copyToClipboard(this)"><code>${data}</code></pre></details>`;
            } else {
                html = `<details><summary>WHOIS</summary><div class="p-2 text-muted small">No WHOIS data</div></details>`;
            }
            break;
        case 'ct':
            if (data && data.error) {
                html = `<details><summary>CT SUBDOMAINS</summary><div class="p-2 text-danger small">${data.error}</div></details>`;
            } else if (data && Object.keys(data).length > 0) {
                html = `<details><summary>CT SUBDOMAINS</summary><ul class="list-unstyled p-2 small m-0" style="max-height: 150px; overflow-y: auto;">`;
                for (const [sub, _] of Object.entries(data)) {
                    html += `<li class="clickable-record" onclick="copyToClipboard(this)"><svg style="width:10px;height:10px;margin-right:8px;fill:#ff4d4d" viewBox="0 0 320 512"><path d="M310.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L242.7 256 73.4 82.7c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l192 192z"/></svg>${sub}</li>`;
                }
                html += `</ul></details>`;
            } else {
                html = `<details><summary>CT SUBDOMAINS</summary><div class="p-2 text-muted small">No subdomains found</div></details>`;
            }
            break;
    }

    section.innerHTML = html;
    
    // Add copy button to summary if it doesn't have one
    section.querySelectorAll('summary').forEach(s => {
        if (!s.querySelector('.section-copy-btn')) {
            const btn = document.createElement('div'); // Using div instead of i
            btn.className = "section-copy-btn d-inline-block ms-2";
            btn.style = "cursor:pointer; width:12px; height:12px;";
            btn.innerHTML = `<svg style="width:12px;height:12px;fill:currentColor;opacity:0.5" viewBox="0 0 448 512"><path d="M208 0H332.1c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9V336c0 26.5-21.5 48-48 48H208c-26.5 0-48-21.5-48-48V48c0-26.5 21.5-48 48-48zM48 128h80v64H64V448H256V416h64v48c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V176c0-26.5 21.5-48 48-48z"/></svg>`;
            btn.title = "Copy Section";
            btn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                const container = s.parentElement.querySelector('div, pre, ul');
                const text = container.innerText;
                navigator.clipboard.writeText(text.trim());
                btn.innerHTML = `<svg style="width:12px;height:12px;fill:#2d5a27" viewBox="0 0 448 512"><path d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/></svg>`;
                setTimeout(() => {
                    btn.innerHTML = `<svg style="width:12px;height:12px;fill:currentColor;opacity:0.5" viewBox="0 0 448 512"><path d="M208 0H332.1c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9V336c0 26.5-21.5 48-48 48H208c-26.5 0-48-21.5-48-48V48c0-26.5 21.5-48 48-48zM48 128h80v64H64V448H256V416h64v48c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V176c0-26.5 21.5-48 48-48z"/></svg>`;
                }, 1500);
            };
            s.appendChild(btn);
        }
    });

    // Initialize tooltips for new content
    tippy(section.querySelectorAll('[title]'), { theme: 'matrix' });
    tippy(section.querySelectorAll('.help-icon'), {
        theme: 'matrix',
        placement: 'right'
    });

    Prism.highlightAllUnder(section);
}

function exportToCSV() {
    const cards = document.querySelectorAll('.result-card');
    if (cards.length === 0) return;

    let csv = "Target,Service,Data\n";
    cards.forEach(card => {
        const target = card.getAttribute('data-target');
        const sections = card.querySelectorAll('.service-section');
        sections.forEach(section => {
            const service = section.getAttribute('data-service');
            const data = section.innerText.replace(/"/g, '""');
            csv += `"${target}","${service}","${data}"\n`;
        });
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('href', url);
    a.setAttribute('download', `scan_results_${new Date().getTime()}.csv`);
    a.click();
}

function exportToJSON() {
    const data = getAllResultsData();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('href', url);
    a.setAttribute('download', `scan_results_${new Date().getTime()}.json`);
    a.click();
}

function copyAllJSON() {
    const data = getAllResultsData();
    navigator.clipboard.writeText(JSON.stringify(data, null, 2));
    alert("All results copied to clipboard as JSON");
}

function getAllResultsData() {
    const cards = document.querySelectorAll('.result-card');
    const results = [];
    cards.forEach(card => {
        const target = card.getAttribute('data-target');
        const sections = {};
        card.querySelectorAll('.service-section').forEach(section => {
            const service = section.getAttribute('data-service');
            sections[service] = section.innerText.trim();
        });
        results.push({ target, services: sections });
    });
    return results;
}

function reScanTarget(btn) {
    const target = btn.closest('.result-card').getAttribute('data-target');
    const isIP = (str) => {
        const regex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$|^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/;
        return regex.test(str);
    };
    const targetIsIP = isIP(target);

    const config = {
        whois: document.getElementById('cfg-whois').checked,
        dns: document.getElementById('cfg-dns').checked,
        ssl: document.getElementById('cfg-ssl').checked,
        http: document.getElementById('cfg-http').checked,
        geo: document.getElementById('cfg-geo').checked,
        ct: document.getElementById('cfg-ct').checked,
        ping: document.getElementById('cfg-ping').checked,
        trace: document.getElementById('cfg-trace').checked,
        route: document.getElementById('cfg-route').checked,
        subdomains: document.getElementById('cfg-subdomains').checked,
        portscan: document.getElementById('cfg-portscan').checked && targetIsIP,
        ports: document.getElementById('cfg-portscan').checked ? document.getElementById('cfg-ports').value : "",
    };
    
    const enabledServices = Object.values(config).filter(v => v && v !== "").length;
    createCard(target);
    activeScans.set(target, {
        total: enabledServices,
        completed: 0
    });
    updateProgressBar(target);
    socket.send(JSON.stringify({ targets: [target], config }));
}

function copyTarget(btn) {
    const card = btn.closest('.result-card');
    const target = card.querySelector('.target-name').innerText;
    const content = card.querySelector('.diagnostic-content').innerText;
    const fullText = `TARGET: ${target}\n\n${content}`;
    
    navigator.clipboard.writeText(fullText.trim());
    
    // Use the global banner for feedback
    const banner = document.getElementById('copyBanner');
    if (banner) {
        banner.classList.add('show');
        setTimeout(() => banner.classList.remove('show'), 2000);
    }

    const originalHTML = btn.innerHTML;
    btn.innerHTML = `<path d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/>`;
    btn.style.fill = "#2d5a27";
    setTimeout(() => {
        btn.innerHTML = originalHTML;
        btn.style.fill = "currentColor";
    }, 2000);
}

// Cookie Management
function setCookie(name, value, days = 7) {
    const expires = new Date(Date.now() + days * 864e5).toUTCString();
    document.cookie = name + '=' + encodeURIComponent(value) + '; expires=' + expires + '; path=/; SameSite=Lax';
}

function getCookie(name) {
    return document.cookie.split('; ').reduce((r, v) => {
        const parts = v.split('=');
        return parts[0] === name ? decodeURIComponent(parts[1]) : r;
    }, '');
}

function saveSettings() {
    const config = {
        whois: document.getElementById('cfg-whois').checked,
        dns: document.getElementById('cfg-dns').checked,
        ssl: document.getElementById('cfg-ssl').checked,
        http: document.getElementById('cfg-http').checked,
        geo: document.getElementById('cfg-geo').checked,
        ct: document.getElementById('cfg-ct').checked,
        ping: document.getElementById('cfg-ping').checked,
        trace: document.getElementById('cfg-trace').checked,
        route: document.getElementById('cfg-route').checked,
        subdomains: document.getElementById('cfg-subdomains').checked,
        portscan: document.getElementById('cfg-portscan').checked,
        ports: document.getElementById('cfg-ports').value
    };
    setCookie('whois_settings', JSON.stringify(config));
}

function loadSettings() {
    const saved = getCookie('whois_settings');
    if (!saved) return;
    try {
        const config = JSON.parse(saved);
        Object.keys(config).forEach(key => {
            const el = document.getElementById('cfg-' + key);
            if (el) {
                if (el.type === 'checkbox') el.checked = config[key];
                else el.value = config[key];
            }
        });
        // Trigger visibility for ports wrapper
        document.getElementById('portsInputWrapper').style.display = config.portscan ? 'block' : 'none';
    } catch (e) { console.error("Failed to load settings", e); }
}

// Keyboard Shortcuts
document.addEventListener('keydown', (e) => {
    // Ctrl + Enter to scan
    if (e.ctrlKey && e.key === 'Enter') {
        startQuery();
    }
    // '/' to focus search
    if (e.key === '/' && document.activeElement.tagName !== 'TEXTAREA') {
        e.preventDefault();
        document.getElementById('targetInput').focus();
    }
});

function clearResults() {
    document.getElementById('resultsGrid').innerHTML = "";
    document.getElementById('targetInput').value = "";
}

async function fetchHistory(btn) {
    const target = btn.closest('.result-card').getAttribute('data-target');
    const modalEl = document.getElementById('toolModal');
    const modal = new bootstrap.Modal(modalEl);
    const title = document.getElementById('toolTitle');
    const body = document.getElementById('toolBody');

    title.innerHTML = `<svg style="width:16px;height:16px;margin-right:8px;fill:#ffc107" viewBox="0 0 512 512"><path d="M75 75L41 109c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0L109 109c9.4-9.4 9.4-24.6 0-33.9s-24.6-9.4-33.9 0zM503 7c-9.4-9.4-24.6-9.4-33.9 0L435 41c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0L503 41c9.4-9.4 9.4-24.6 0-33.9zM9 403c-9.4 9.4-9.4 24.6 0 33.9l34 34c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-34-34c-9.4-9.4-24.6-9.4-33.9 0zM437 437c-9.4 9.4-9.4 24.6 0 33.9l34 34c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-34-34c-9.4-9.4-24.6-9.4-33.9 0zM256 160c-53 0-96 43-96 96s43 96 96 96s96-43 96-96s-43-96-96-96zm0 256c-88.4 0-160-71.6-160-160s71.6-160 160-160s160 71.6 160 160s-71.6 160-160 160z"/></svg> <span></span>`;
    title.querySelector('span').textContent = `HISTORY: ${target}`;
    body.innerHTML = `<div class="text-center p-4"><div class="spinner-border text-nordic-blue"></div></div>`;
    modal.show();

    try {
        const resp = await fetch(`/history/${target}`);
        const data = await resp.json();

        if (data.error) {
            body.innerHTML = `<div class="alert bg-danger-dim text-danger border-0">${data.error}</div>`;
            return;
        }

        if (!data.entries || data.entries.length === 0) {
            body.innerHTML = `<div class="alert bg-nordic-blue-dim text-nordic-blue border-0">No historical data found for this target.</div>`;
            return;
        }

        let html = `<div class="history-list">`;
        
        // Show Diffs if any
        if (data.diffs && data.diffs.length > 0) {
            html += `<div class="mb-4">
                        <h6 class="text-danger fw-bold small mb-2">RECENT CHANGES</h6>
                        <ul class="list-group list-group-flush bg-transparent">`;
            data.diffs.forEach(d => {
                html += `<li class="list-group-item bg-transparent text-main border-secondary border-opacity-25 py-2 small font-monospace">${d}</li>`;
            });
            html += `</ul></div>`;
        }

        html += `<h6 class="text-nordic-blue fw-bold small mb-2">TIMELINE</h6>`;
        data.entries.forEach(entry => {
            const date = new Date(entry.timestamp).toLocaleString();
            let parsedResult = {};
            try {
                parsedResult = JSON.parse(entry.result);
            } catch(e) {
                parsedResult = { raw: entry.result };
            }
            html += `<details class="mb-2">
                        <summary class="py-2 small">${date}</summary>
                        <div class="p-2 bg-dark rounded mt-1">
                            <pre class="mb-0 text-info font-monospace" style="font-size: 0.65rem; max-height: 200px; overflow-y: auto;"><code>${JSON.stringify(parsedResult, null, 2)}</code></pre>
                        </div>
                    </details>`;
        });
        
        html += `</div>`;
        body.innerHTML = html;
    } catch (e) {
        body.innerHTML = `<div class="alert bg-danger-dim text-danger border-0">Failed to fetch history data.</div>`;
    }
}

// Add event listeners for saving
document.querySelectorAll('.feature-toggle input, #cfg-ports').forEach(el => {
    el.addEventListener('change', saveSettings);
});

document.getElementById('cfg-portscan').addEventListener('change', (e) => {
    document.getElementById('portsInputWrapper').style.display = e.target.checked ? 'block' : 'none';
});
</script>

{{ template "footer" . }}
